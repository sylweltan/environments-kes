on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Manually trigger the workflow from the Actions tab
    inputs:
      dotnet-core-version:
        description: 'DotNet Core SDK version'
        required: true
        default: '3.1'

jobs:
  build:
    #if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup .Net Core SDK ${{ env.DOTNET_CORE_VERSION }}
        run: echo "Setup .Net Core SDK ${{ env.DOTNET_CORE_VERSION }}"
      - name: Restore packages
        run: echo "dotnet restore"
      - name: dotnet build
        run: echo "dotnet build"
      - name: dotnet test
        run: echo "dotnet test"
      - name: dotnet publish
        run: echo "dotnet publish"

  staging:
    needs: build
    name: Deploy to staging
    environment:
      name: staging
      #url: ${{ steps.deploy_staging.outputs.webapp-url }}
      url: 'https://edge-staging.sylweltan.com'
    runs-on: ubuntu-latest
    steps:
    # Download artifacts
    - name: Download artifacts
      run: "echo downlooad artifacts - actions/download-artifact@v2"
    # Deploy
    - name: Deploy to staging
      id: deploy_staging
      run: | 
        echo "Deploy to staging"
        echo "app_name: ${{ secrets.APP_NAME }}"
        echo "app_secret: ${{ secrets.APP_SECRET }}"

  deploy:
    needs: build
    name: Deploy to production
    environment:
      name: production
      url: 'https://edge.sylweltan.com'
    runs-on: ubuntu-latest
    steps:
      # Download artifacts
      - name: Download artifacts
        run: "echo downlooad artifacts - actions/download-artifact@v2"
      # Deploy
      - name: Deploy to production
        id: deploy_production
        run: | 
          echo "Deploy to production"
          echo "app_name: ${{ secrets.APP_NAME }}"
          echo "app_secret: ${{ secrets.APP_SECRET }}"
